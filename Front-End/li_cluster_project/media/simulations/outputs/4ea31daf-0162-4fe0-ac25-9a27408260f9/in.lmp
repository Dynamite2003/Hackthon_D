# TMD simulation using spring forces toward target
units metal
atom_style atomic
boundary f f f

# Read initial structure
read_data input.data

# Li-Li interactions using Lennard-Jones potential
pair_style lj/cut 10.0
pair_coeff 1 1 0.05 2.5

# Define atom groups
group mobile id > 0

# Energy minimization
minimize 1.0e-4 1.0e-6 1000 10000

# Initialize velocities with very low temperature for stability
velocity mobile create 10.0 4928459 rot yes dist gaussian

# Progressive TMD implementation - gradually increase spring strength
# Read target coordinates and apply spring force for each atom
variable k_start equal 0.5   # Initial weak spring
variable k_mid equal 5.0     # Medium spring strength  
variable k_final equal 15.0  # Strong final spring

# Apply spring forces toward target positions for each atom
# We'll use individual fix spring commands for each atom
group atom1 id 1
group atom2 id 2
group atom3 id 3
group atom4 id 4
group atom5 id 5
group atom6 id 6
group atom7 id 7
group atom8 id 8
group atom9 id 9

# Progressive TMD with increasing spring strength
# Output trajectory every 50 steps
dump traj_dump all xyz 50 trajectory.xyz
dump_modify traj_dump element Li

# Thermodynamics output
thermo_style custom step temp press etotal pe ke
thermo 100
timestep 0.001

# Stage 1: Weak springs for initial guidance
fix spring1_1 atom1 spring tether ${k_start} -2.518000 1.161000 0.760000 0.0
fix spring2_1 atom2 spring tether ${k_start} -1.265000 -1.351000 1.915000 0.0
fix spring3_1 atom3 spring tether ${k_start} -0.036000 2.728000 -0.574000 0.0
fix spring4_1 atom4 spring tether ${k_start} 1.161000 -2.050000 0.433000 0.0
fix spring5_1 atom5 spring tether ${k_start} 1.161000 -1.180000 -2.430000 0.0
fix spring6_1 atom6 spring tether ${k_start} -1.729000 -2.086000 -1.024000 0.0
fix spring7_1 atom7 spring tether ${k_start} -0.325000 0.032000 -0.397000 0.0
fix spring8_1 atom8 spring tether ${k_start} 2.337000 0.631000 -0.298000 0.0
fix spring9_1 atom9 spring tether ${k_start} 0.378000 1.100000 1.978000 0.0

fix nvt_1 mobile nvt temp 10.0 10.0 10.0
run 8000

# Stage 2: Medium springs with cooling
unfix spring1_1
unfix spring2_1
unfix spring3_1
unfix spring4_1
unfix spring5_1
unfix spring6_1
unfix spring7_1
unfix spring8_1
unfix spring9_1
fix spring1_2 atom1 spring tether ${k_mid} -2.518000 1.161000 0.760000 0.0
fix spring2_2 atom2 spring tether ${k_mid} -1.265000 -1.351000 1.915000 0.0
fix spring3_2 atom3 spring tether ${k_mid} -0.036000 2.728000 -0.574000 0.0
fix spring4_2 atom4 spring tether ${k_mid} 1.161000 -2.050000 0.433000 0.0
fix spring5_2 atom5 spring tether ${k_mid} 1.161000 -1.180000 -2.430000 0.0
fix spring6_2 atom6 spring tether ${k_mid} -1.729000 -2.086000 -1.024000 0.0
fix spring7_2 atom7 spring tether ${k_mid} -0.325000 0.032000 -0.397000 0.0
fix spring8_2 atom8 spring tether ${k_mid} 2.337000 0.631000 -0.298000 0.0
fix spring9_2 atom9 spring tether ${k_mid} 0.378000 1.100000 1.978000 0.0

unfix nvt_1
fix nvt_2 mobile nvt temp 10.0 3.0 20.0
run 12000

# Stage 3: Strong springs for final convergence
unfix spring1_2
unfix spring2_2
unfix spring3_2
unfix spring4_2
unfix spring5_2
unfix spring6_2
unfix spring7_2
unfix spring8_2
unfix spring9_2
fix spring1_3 atom1 spring tether ${k_final} -2.518000 1.161000 0.760000 0.0
fix spring2_3 atom2 spring tether ${k_final} -1.265000 -1.351000 1.915000 0.0
fix spring3_3 atom3 spring tether ${k_final} -0.036000 2.728000 -0.574000 0.0
fix spring4_3 atom4 spring tether ${k_final} 1.161000 -2.050000 0.433000 0.0
fix spring5_3 atom5 spring tether ${k_final} 1.161000 -1.180000 -2.430000 0.0
fix spring6_3 atom6 spring tether ${k_final} -1.729000 -2.086000 -1.024000 0.0
fix spring7_3 atom7 spring tether ${k_final} -0.325000 0.032000 -0.397000 0.0
fix spring8_3 atom8 spring tether ${k_final} 2.337000 0.631000 -0.298000 0.0
fix spring9_3 atom9 spring tether ${k_final} 0.378000 1.100000 1.978000 0.0

unfix nvt_2
fix nvt_3 mobile nvt temp 3.0 1.0 20.0
run 10000

# Cleanup springs
unfix spring1_3
unfix spring2_3
unfix spring3_3
unfix spring4_3
unfix spring5_3
unfix spring6_3
unfix spring7_3
unfix spring8_3
unfix spring9_3

# Final cleanup
unfix nvt_3
undump traj_dump
