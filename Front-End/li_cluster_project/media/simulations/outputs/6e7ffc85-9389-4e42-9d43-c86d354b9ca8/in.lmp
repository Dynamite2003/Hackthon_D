# TMD simulation using spring forces toward target
units metal
atom_style atomic
boundary f f f

# Read initial structure
read_data input.data

# Li-Li interactions using Lennard-Jones potential
pair_style lj/cut 10.0
pair_coeff 1 1 0.05 2.5

# Define atom groups
group mobile id > 0

# Energy minimization
minimize 1.0e-4 1.0e-6 1000 10000

# Initialize velocities with minimal temperature for nearly static start
velocity mobile create 1.0 4928459 rot yes dist gaussian

# Progressive TMD implementation - extremely gentle multi-stage approach
# Read target coordinates and apply spring force for each atom
variable k_stage1 equal 0.02  # Minimal initial spring
variable k_stage2 equal 0.1   # Very weak spring  
variable k_stage3 equal 1.0   # Weak-moderate spring
variable k_final equal 5.0    # Final moderate spring

# Apply spring forces toward target positions for each atom
# We'll use individual fix spring commands for each atom
group atom1 id 1
group atom2 id 2
group atom3 id 3
group atom4 id 4
group atom5 id 5
group atom6 id 6
group atom7 id 7
group atom8 id 8
group atom9 id 9

# 4-Stage Ultra-Progressive TMD with minimal initial movement
# Output trajectory every 50 steps
dump traj_dump all xyz 50 trajectory.xyz
dump_modify traj_dump element Li

# Thermodynamics output
thermo_style custom step temp press etotal pe ke
thermo 100
timestep 0.001

# Stage 1: Minimal springs for ultra-gentle start
fix spring1_1 atom1 spring tether ${k_stage1} -2.518000 1.161000 0.760000 0.0
fix spring2_1 atom2 spring tether ${k_stage1} -1.265000 -1.351000 1.915000 0.0
fix spring3_1 atom3 spring tether ${k_stage1} -0.036000 2.728000 -0.574000 0.0
fix spring4_1 atom4 spring tether ${k_stage1} 1.161000 -2.050000 0.433000 0.0
fix spring5_1 atom5 spring tether ${k_stage1} 1.161000 -1.180000 -2.430000 0.0
fix spring6_1 atom6 spring tether ${k_stage1} -1.729000 -2.086000 -1.024000 0.0
fix spring7_1 atom7 spring tether ${k_stage1} -0.325000 0.032000 -0.397000 0.0
fix spring8_1 atom8 spring tether ${k_stage1} 2.337000 0.631000 -0.298000 0.0
fix spring9_1 atom9 spring tether ${k_stage1} 0.378000 1.100000 1.978000 0.0

fix nvt_1 mobile nvt temp 1.0 1.5 40.0
run 8000

# Stage 2: Very weak springs with minimal heating
unfix spring1_1
unfix spring2_1
unfix spring3_1
unfix spring4_1
unfix spring5_1
unfix spring6_1
unfix spring7_1
unfix spring8_1
unfix spring9_1
fix spring1_2 atom1 spring tether ${k_stage2} -2.518000 1.161000 0.760000 0.0
fix spring2_2 atom2 spring tether ${k_stage2} -1.265000 -1.351000 1.915000 0.0
fix spring3_2 atom3 spring tether ${k_stage2} -0.036000 2.728000 -0.574000 0.0
fix spring4_2 atom4 spring tether ${k_stage2} 1.161000 -2.050000 0.433000 0.0
fix spring5_2 atom5 spring tether ${k_stage2} 1.161000 -1.180000 -2.430000 0.0
fix spring6_2 atom6 spring tether ${k_stage2} -1.729000 -2.086000 -1.024000 0.0
fix spring7_2 atom7 spring tether ${k_stage2} -0.325000 0.032000 -0.397000 0.0
fix spring8_2 atom8 spring tether ${k_stage2} 2.337000 0.631000 -0.298000 0.0
fix spring9_2 atom9 spring tether ${k_stage2} 0.378000 1.100000 1.978000 0.0

unfix nvt_1
fix nvt_2 mobile nvt temp 1.5 2.0 40.0
run 10000

# Stage 3: Weak-moderate springs with gradual heating
unfix spring1_2
unfix spring2_2
unfix spring3_2
unfix spring4_2
unfix spring5_2
unfix spring6_2
unfix spring7_2
unfix spring8_2
unfix spring9_2
fix spring1_3 atom1 spring tether ${k_stage3} -2.518000 1.161000 0.760000 0.0
fix spring2_3 atom2 spring tether ${k_stage3} -1.265000 -1.351000 1.915000 0.0
fix spring3_3 atom3 spring tether ${k_stage3} -0.036000 2.728000 -0.574000 0.0
fix spring4_3 atom4 spring tether ${k_stage3} 1.161000 -2.050000 0.433000 0.0
fix spring5_3 atom5 spring tether ${k_stage3} 1.161000 -1.180000 -2.430000 0.0
fix spring6_3 atom6 spring tether ${k_stage3} -1.729000 -2.086000 -1.024000 0.0
fix spring7_3 atom7 spring tether ${k_stage3} -0.325000 0.032000 -0.397000 0.0
fix spring8_3 atom8 spring tether ${k_stage3} 2.337000 0.631000 -0.298000 0.0
fix spring9_3 atom9 spring tether ${k_stage3} 0.378000 1.100000 1.978000 0.0

unfix nvt_2
fix nvt_3 mobile nvt temp 2.0 1.5 30.0
run 12000

# Stage 4: Final convergence with moderate springs
unfix spring1_3
unfix spring2_3
unfix spring3_3
unfix spring4_3
unfix spring5_3
unfix spring6_3
unfix spring7_3
unfix spring8_3
unfix spring9_3
fix spring1_4 atom1 spring tether ${k_final} -2.518000 1.161000 0.760000 0.0
fix spring2_4 atom2 spring tether ${k_final} -1.265000 -1.351000 1.915000 0.0
fix spring3_4 atom3 spring tether ${k_final} -0.036000 2.728000 -0.574000 0.0
fix spring4_4 atom4 spring tether ${k_final} 1.161000 -2.050000 0.433000 0.0
fix spring5_4 atom5 spring tether ${k_final} 1.161000 -1.180000 -2.430000 0.0
fix spring6_4 atom6 spring tether ${k_final} -1.729000 -2.086000 -1.024000 0.0
fix spring7_4 atom7 spring tether ${k_final} -0.325000 0.032000 -0.397000 0.0
fix spring8_4 atom8 spring tether ${k_final} 2.337000 0.631000 -0.298000 0.0
fix spring9_4 atom9 spring tether ${k_final} 0.378000 1.100000 1.978000 0.0

unfix nvt_3
fix nvt_4 mobile nvt temp 1.5 1.0 30.0
run 10000

# Cleanup springs
unfix spring1_4
unfix spring2_4
unfix spring3_4
unfix spring4_4
unfix spring5_4
unfix spring6_4
unfix spring7_4
unfix spring8_4
unfix spring9_4

# Final cleanup
unfix nvt_4
undump traj_dump
